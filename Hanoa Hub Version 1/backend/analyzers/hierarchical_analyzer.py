"""
ê³„ì¸µì  AI ë¶„ì„ê¸°
GPT-5-mini ìš°ì„  ì‚¬ìš© â†’ ì‹ ë¢°ë„ 70% ë¯¸ë§Œ ì‹œ GPT-5 ê²€ìˆ˜
í•´ì„¤ ìë™ìƒì„± ì œì™¸, ê°œë…/í‚¤ì›Œë“œ/ë‚œì´ë„ë§Œ ë¶„ì„
"""
import json
import openai
from typing import Dict, List, Tuple, Any
from datetime import datetime

from config import OPENAI_API_KEY

# OpenAI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
openai.api_key = OPENAI_API_KEY

# API ì‚¬ìš©ëŸ‰ ì¶”ì 
try:
    from api_usage_tracker import api_tracker
except ImportError:
    api_tracker = None

class HierarchicalAnalyzer:
    """ê³„ì¸µì  ë¬¸ì œ ë¶„ì„ê¸° - ë¹„ìš© íš¨ìœ¨ì„±ê³¼ í’ˆì§ˆ ë³´ì¥"""

    def __init__(self):
        # 2025ë…„ ê¸°ì¤€ ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥í•œ GPT-5 ì‹œë¦¬ì¦ˆ ëª¨ë¸
        self.gpt5_mini_model = "gpt-5-mini"  # GPT-5 Mini (í™•ì¸ë¨)
        self.gpt5_model = "gpt-5"  # GPT-5 Full (í™•ì¸ë¨)
        self.confidence_threshold = 0.70

    def analyze_problem(self, question_text: str, choices: List[str], correct_answer: str) -> Dict[str, Any]:
        """
        ë¬¸ì œ ë¶„ì„ ë©”ì¸ í•¨ìˆ˜
        í•´ì„¤ ì œì™¸í•˜ê³  ê°œë…/í‚¤ì›Œë“œ/ë‚œì´ë„ë§Œ ë¶„ì„
        """
        try:
            # Step 1: GPT-5-minië¡œ ì´ˆê¸° ë¶„ì„
            mini_result = self._analyze_with_mini(question_text, choices, correct_answer)
            confidence_score = self._calculate_confidence(mini_result)

            # Step 2: ì‹ ë¢°ë„ ì²´í¬ ë° GPT-5 ê²€ìˆ˜
            if confidence_score < self.confidence_threshold:
                print(f"[WARNING] ì‹ ë¢°ë„ {confidence_score:.2%} - GPT-5 ê²€ìˆ˜ ì§„í–‰")
                final_result = self._enhance_with_gpt5(question_text, choices, correct_answer, mini_result)
                verified_by = "gpt5_enhanced"
            else:
                print(f"[SUCCESS] ì‹ ë¢°ë„ {confidence_score:.2%} - GPT-5-mini ê²°ê³¼ ìŠ¹ì¸")
                final_result = mini_result
                verified_by = "gpt5_mini"

            # ìµœì¢… ê²°ê³¼ êµ¬ì„±
            return {
                "concepts": final_result.get("concepts", []),
                "keywords": final_result.get("keywords", []),
                "difficulty": final_result.get("difficulty", "ë³´í†µ"),
                "confidence_score": confidence_score,
                "verified_by": verified_by,
                "processed_at": datetime.now().isoformat()
            }

        except Exception as e:
            print(f"[ERROR] ë¶„ì„ ì‹¤íŒ¨: {e}")
            return {
                "concepts": [],
                "keywords": [],
                "difficulty": "ë³´í†µ",
                "confidence_score": 0.0,
                "verified_by": "error",
                "error": str(e)
            }

    def _analyze_with_mini(self, question_text: str, choices: List[str], correct_answer: str) -> Dict[str, Any]:
        """GPT-5-minië¡œ ì´ˆê¸° ë¶„ì„"""

        prompt = f"""
ë‹¤ìŒ ê°„í˜¸í•™/ì˜í•™ ë¬¸ì œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:

ë¬¸ì œ: {question_text}
ì„ íƒì§€: {', '.join(choices)}
ì •ë‹µ: {correct_answer}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ JSON ì‘ë‹µí•´ì£¼ì„¸ìš”:
{{
    "concepts": ["í•µì‹¬ ê°œë…1", "í•µì‹¬ ê°œë…2", "í•µì‹¬ ê°œë…3"],
    "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3", "í‚¤ì›Œë“œ4", "í‚¤ì›Œë“œ5"],
    "difficulty": "ìƒ|ì¤‘|í•˜",
    "reasoning": "ë¶„ì„ ê·¼ê±°"
}}

ìš”êµ¬ì‚¬í•­:
1. concepts: ìµœì†Œ 2ê°œ, ìµœëŒ€ 5ê°œì˜ í•µì‹¬ ì˜í•™/ê°„í˜¸í•™ ê°œë…
2. keywords: ìµœì†Œ 3ê°œ, ìµœëŒ€ 8ê°œì˜ ê´€ë ¨ í‚¤ì›Œë“œ
3. difficulty: ê°„í˜¸ì‚¬/ì˜ì‚¬ êµ­ê°€ê³ ì‹œ ê¸°ì¤€ ë‚œì´ë„
4. reasoning: ë¶„ë¥˜ ê·¼ê±° ê°„ë‹¨íˆ ì„¤ëª…
"""

        try:
            response = openai.chat.completions.create(
                model=self.gpt5_mini_model,
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ì˜í•™/ê°„í˜¸í•™ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë¬¸ì œë¥¼ ì •í™•íˆ ë¶„ì„í•˜ì—¬ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¥¼ ì œê³µí•©ë‹ˆë‹¤."},
                    {"role": "user", "content": prompt}
                ],
                max_completion_tokens=1000  # GPT-5 uses max_completion_tokens
                # temperature parameter removed - GPT-5 only supports default value
            )

            # API ì‚¬ìš©ëŸ‰ ì¶”ì 
            if api_tracker:
                input_tokens = response.usage.prompt_tokens if hasattr(response, 'usage') else len(prompt) // 4
                output_tokens = response.usage.completion_tokens if hasattr(response, 'usage') else 1000
                api_tracker.track_usage(self.gpt5_mini_model, input_tokens, output_tokens)

            content = response.choices[0].message.content.strip()
            # JSON íŒŒì‹± ì‹œë„
            if content.startswith("```json"):
                content = content.replace("```json", "").replace("```", "").strip()

            result = json.loads(content)
            return result

        except Exception as e:
            print(f"[ERROR] GPT-5-mini ë¶„ì„ ì‹¤íŒ¨: {e}")
            return {
                "concepts": ["ë¶„ì„ì‹¤íŒ¨"],
                "keywords": ["ì˜¤ë¥˜"],
                "difficulty": "ë³´í†µ",
                "reasoning": f"ë¶„ì„ ì‹¤íŒ¨: {str(e)}"
            }

    def _calculate_confidence(self, result: Dict[str, Any]) -> float:
        """ë¶„ì„ ê²°ê³¼ì˜ ì‹ ë¢°ë„ ê³„ì‚°"""
        scores = []

        # 1. ê°œë… ê°œìˆ˜ ë° í’ˆì§ˆ (40%)
        concepts = result.get("concepts", [])
        if len(concepts) >= 2:
            concept_score = min(len(concepts) / 4, 1.0)  # ìµœëŒ€ 4ê°œ ê¸°ì¤€
        else:
            concept_score = 0.3
        scores.append(concept_score * 0.4)

        # 2. í‚¤ì›Œë“œ ê°œìˆ˜ ë° í’ˆì§ˆ (30%)
        keywords = result.get("keywords", [])
        if len(keywords) >= 3:
            keyword_score = min(len(keywords) / 6, 1.0)  # ìµœëŒ€ 6ê°œ ê¸°ì¤€
        else:
            keyword_score = 0.2
        scores.append(keyword_score * 0.3)

        # 3. ë‚œì´ë„ ë¶„ë¥˜ ìœ íš¨ì„± (20%)
        difficulty = result.get("difficulty", "")
        if difficulty in ["ìƒ", "ì¤‘", "í•˜"]:
            difficulty_score = 1.0
        else:
            difficulty_score = 0.0
        scores.append(difficulty_score * 0.2)

        # 4. ë¶„ì„ ê·¼ê±° ì œê³µ ì—¬ë¶€ (10%)
        reasoning = result.get("reasoning", "")
        if len(reasoning) > 10:
            reasoning_score = 1.0
        else:
            reasoning_score = 0.0
        scores.append(reasoning_score * 0.1)

        return sum(scores)

    def _enhance_with_gpt5(self, question_text: str, choices: List[str], correct_answer: str, mini_result: Dict[str, Any]) -> Dict[str, Any]:
        """GPT-5ë¡œ ê²€ìˆ˜ ë° ê°œì„ """

        prompt = f"""
ë‹¤ìŒ ê°„í˜¸í•™/ì˜í•™ ë¬¸ì œì˜ GPT-5-mini ë¶„ì„ ê²°ê³¼ë¥¼ ê²€ìˆ˜í•˜ê³  ê°œì„ í•´ì£¼ì„¸ìš”:

ë¬¸ì œ: {question_text}
ì„ íƒì§€: {', '.join(choices)}
ì •ë‹µ: {correct_answer}

GPT-5-mini ë¶„ì„ ê²°ê³¼:
- ê°œë…: {mini_result.get('concepts', [])}
- í‚¤ì›Œë“œ: {mini_result.get('keywords', [])}
- ë‚œì´ë„: {mini_result.get('difficulty', '')}

ë¬¸ì œì  ë¶„ì„ ë° ê°œì„ ëœ ê²°ê³¼ë¥¼ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì œê³µí•´ì£¼ì„¸ìš”:
{{
    "concepts": ["ê°œì„ ëœ í•µì‹¬ ê°œë…ë“¤"],
    "keywords": ["ê°œì„ ëœ í‚¤ì›Œë“œë“¤"],
    "difficulty": "ìƒ|ì¤‘|í•˜",
    "improvements": "ì–´ë–¤ ë¶€ë¶„ì„ ê°œì„ í–ˆëŠ”ì§€ ì„¤ëª…"
}}

ê²€ìˆ˜ ê¸°ì¤€:
1. ì˜í•™/ê°„í˜¸í•™ì  ì •í™•ì„±
2. ê°œë…ì˜ ì™„ì„±ë„ (ëˆ„ë½ëœ í•µì‹¬ ê°œë… ì¶”ê°€)
3. í‚¤ì›Œë“œì˜ ê´€ë ¨ì„± ë° ì¶©ë¶„ì„±
4. ë‚œì´ë„ ë¶„ë¥˜ì˜ ì ì ˆì„±
"""

        try:
            response = openai.chat.completions.create(
                model=self.gpt5_model,
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ì˜í•™/ê°„í˜¸í•™ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. GPT-5-mini ê²°ê³¼ë¥¼ ê²€í† í•˜ê³  ì „ë¬¸ì  ê´€ì ì—ì„œ ê°œì„ í•©ë‹ˆë‹¤."},
                    {"role": "user", "content": prompt}
                ],
                max_completion_tokens=1200  # GPT-5 uses max_completion_tokens
                # temperature parameter removed - GPT-5 only supports default value
            )

            # API ì‚¬ìš©ëŸ‰ ì¶”ì 
            if api_tracker:
                input_tokens = response.usage.prompt_tokens if hasattr(response, 'usage') else len(prompt) // 4
                output_tokens = response.usage.completion_tokens if hasattr(response, 'usage') else 1200
                api_tracker.track_usage(self.gpt5_model, input_tokens, output_tokens)

            content = response.choices[0].message.content.strip()
            if content.startswith("```json"):
                content = content.replace("```json", "").replace("```", "").strip()

            enhanced_result = json.loads(content)
            return enhanced_result

        except Exception as e:
            print(f"[ERROR] GPT-5 ê²€ìˆ˜ ì‹¤íŒ¨, mini ê²°ê³¼ ì‚¬ìš©: {e}")
            return mini_result

# ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
hierarchical_analyzer = HierarchicalAnalyzer()

if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸
    test_question = "í˜ˆì•• ì¸¡ì • ì‹œ ê°€ì¥ ì¤‘ìš”í•œ ì£¼ì˜ì‚¬í•­ì€?"
    test_choices = [
        "í™˜ìë¥¼ í¸ì•ˆí•˜ê²Œ ì•‰íŒë‹¤",
        "ì¸¡ì • ì „ 30ë¶„ê°„ ê¸ˆì—°í•œë‹¤",
        "ì»¤í”„ í¬ê¸°ëŠ” ìƒê´€ì—†ë‹¤",
        "ì¸¡ì • ì§í›„ ë°”ë¡œ ìš´ë™í•œë‹¤"
    ]
    test_answer = "ì¸¡ì • ì „ 30ë¶„ê°„ ê¸ˆì—°í•œë‹¤"

    result = hierarchical_analyzer.analyze_problem(test_question, test_choices, test_answer)
    print("\nğŸ“‹ ë¶„ì„ ê²°ê³¼:")
    print(json.dumps(result, ensure_ascii=False, indent=2))