rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // 사용자 프로필 이미지
    match /user_profiles/{userId}/profile.jpg {
      // 사용자는 자신의 프로필 이미지만 읽고 쓸 수 있음
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // 파일 크기 제한 (5MB)
      allow write: if request.auth != null && 
                   request.auth.uid == userId &&
                   request.resource.size <= 5 * 1024 * 1024;
    }

    // 운동 이미지/동영상
    match /workout_media/{userId}/{allPaths=**} {
      // 사용자는 자신의 운동 미디어만 접근 가능
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // 파일 크기 제한 (50MB)
      allow write: if request.auth != null && 
                   request.auth.uid == userId &&
                   request.resource.size <= 50 * 1024 * 1024 &&
                   request.resource.contentType.matches('image/.*|video/.*');
    }

    // 운동 진행 상황 스크린샷
    match /workout_screenshots/{userId}/{sessionId}/{fileName} {
      // 사용자는 자신의 운동 스크린샷만 접근 가능
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // 이미지 파일만 허용, 크기 제한 (10MB)
      allow write: if request.auth != null && 
                   request.auth.uid == userId &&
                   request.resource.size <= 10 * 1024 * 1024 &&
                   request.resource.contentType.matches('image/.*');
    }

    // 공용 운동 리소스 (읽기 전용)
    match /exercise_resources/{allPaths=**} {
      // 모든 인증된 사용자가 운동 리소스를 읽을 수 있음
      allow read: if request.auth != null;
      // 쓰기는 관리자만 가능
      allow write: if request.auth != null && 
                   request.auth.token.admin == true;
    }

    // 기본적으로 모든 파일에 대한 접근 거부
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}